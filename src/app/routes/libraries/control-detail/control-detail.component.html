<p-toast></p-toast>

<p-confirmDialog> </p-confirmDialog>

<div id="table1">
    <div class="card px-3 py-3">
        <p-table
            *ngIf="showTable"
            style="padding-bottom: -3px !important"
            #dt
            [value]="controls"
            [rows]="10"
            [loading]="loading"
            [rowHover]="true"
            [paginator]="true"
            [globalFilterFields]="[
                'control_uid',
                'aulftxt',
                'bannertxt',
                'risktxt',
                'control',
                'comments',
                'controltxt',
                'frequencytxt',
                'autotxt',
                'categorytxt',
                'asstxt',
                'keytxt'
            ]"
            [rowsPerPageOptions]="[10, 20, 30]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            responsiveLayout="scroll"
            [scrollable]="true"
            scrollHeight="calc(100vh - 305px)"
        >
            <ng-template pTemplate="caption">
                <div
                    class="table-header flex justify-content-between align-items-center"
                >
                    <span class="text-xl">List of Control</span>
                    <span class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input
                            pInputText
                            type="text"
                            (input)="
                                dt.filterGlobal($event.target.value, 'contains')
                            "
                            placeholder="Global Search"
                        />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th
                        pFrozenColumn
                        pSortableColumn="control_uid"
                        style="min-width: 14rem"
                    >
                        <div class="flex align-items-center">
                            CONTROL UID
                            <p-sortIcon field="control_uid"></p-sortIcon>
                        </div>
                    </th>

                    <th
                        pSortableColumn="au_level_4_uid"
                        style="min-width: 14rem"
                    >
                        <div class="flex align-items-center">
                            AU LEVEL 4 UID
                            <p-sortIcon field="au_level_4_uid"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="banner_uid" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            DEPARTMENT UID
                            <p-sortIcon field="banner_uid"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="risk_uid" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            RISK UID
                            <p-sortIcon field="risk_uid"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="organization" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            ORGANIZATION
                            <p-sortIcon field="organization"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="control" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            CONTROL
                            <p-sortIcon field="control"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="comments" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            COMMENT
                            <p-sortIcon field="comments"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="control_type" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            CONTROL TYPE
                            <p-sortIcon field="control_type"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="frequency" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            FREQUENCY
                            <p-sortIcon field="frequency"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="automation" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            AUTOMATION
                            <p-sortIcon field="automation"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="category" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            CATEGORY
                            <p-sortIcon field="category"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="assertion" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            ASSERTION
                            <p-sortIcon field="assertion"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="key_control" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            KEY CONTROL
                            <p-sortIcon field="key_control"></p-sortIcon>
                        </div>
                    </th>

                    <th
                        style="width: 120px"
                        pFrozenColumn
                        alignFrozen="right"
                        class="justify-content-LEFT"
                    >
                        ACTIONS
                    </th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr>
                    <td
                        class="text-base"
                        pFrozenColumn
                        style="min-width: 14rem"
                    >
                        {{ item.control_uid }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.aulftxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.bannertxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.risktxt }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.organization }}
                    </td>
                    <td
                        class="text-base"
                        style="min-width: 14rem"
                        (click)="
                            utilService.getFullView('Control', item.control)
                        "
                        pTooltip="click to view more"
                        tooltipPosition="bottom"
                    >
                        {{ item.control.slice(0, 30) }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.comments }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.controltxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.frequencytxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.autotxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.categorytxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.asstxt }}
                    </td>

                    <td class="text-base" style="min-width: 14rem">
                        {{ item.keytxt }}
                    </td>

                    <td
                        style="width: 120px"
                        pFrozenColumn
                        class="font-bold"
                        alignFrozen="right"
                    >
                        <span
                            ><button
                                pButton
                                pRipple
                                title="Edit"
                                type="button"
                                icon="pi pi-pencil"
                                class="p-button-rounded p-button-info"
                                (click)="openNew(item)"
                            ></button>
                            <button
                                pButton
                                pRipple
                                title="Delete"
                                type="button"
                                icon="pi pi-trash"
                                class="p-button-rounded p-button-info ml-2"
                                (click)="deleteSelectedcontrols(item)"
                            ></button
                        ></span>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="14">No controls found.</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
                <tr>
                    <td colspan="14">Loading controls data. Please wait.</td>
                </tr>
            </ng-template>
        </p-table>

        <div *ngIf="!showTable">
            <h5>Control Detail</h5>
            <form [formGroup]="form" (ngSubmit)="saveControl()">
                <div class="p-fluid p-formgrid grid">
                    <div class="field col-12 md:col-4">
                        <label>Organisation <sup>*</sup></label>
                        <p-autoComplete
                            appendTo="body"
                            formControlName="organization"
                            [suggestions]="filteredOrg"
                            (completeMethod)="filterOrg($event)"
                            field="organization"
                            [dropdown]="true"
                            placeholder="Select Organisation"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Risk<sup>*</sup></label>
                        <p-autoComplete
                            appendTo="body"
                            formControlName="riskdesc"
                            [suggestions]="filteredRisk"
                            (completeMethod)="filterRisk($event)"
                            field="risk"
                            [dropdown]="true"
                            placeholder="Select Risk"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>AU Level-4<sup>*</sup></label>
                        <p-autoComplete
                            appendTo="body"
                            formControlName="aulfdesc"
                            [suggestions]="filteredAuditUnivFour"
                            (completeMethod)="filterAllAuditUnivFour($event)"
                            field="au_level_4_desc"
                            [dropdown]="true"
                            placeholder="Select Audit Level-4"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Department<sup>*</sup></label>
                        <p-autoComplete
                            appendTo="body"
                            formControlName="bannerdesc"
                            [suggestions]="filteredDepartment"
                            (completeMethod)="filterDepartment($event)"
                            field="department"
                            [dropdown]="true"
                            placeholder="Select Department"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label for="department" class="block"
                            >Control <sup>*</sup></label
                        >
                        <input
                            formControlName="control"
                            type="text"
                            pInputText
                            [style]="{ width: '100%' }"
                        />
                    </div>

                    <div class="field col-12 md:col-4">
                        <label for="department" class="block"
                            >Comments <sup>*</sup></label
                        >
                        <input
                            formControlName="comments"
                            type="text"
                            pInputText
                            [style]="{ width: '100%' }"
                        />
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Control Type<sup>*</sup></label>
                        <p-autoComplete
                            [disabled]="form.get('organization').value == null"
                            appendTo="body"
                            formControlName="controldesc"
                            [suggestions]="filteredControlType"
                            (completeMethod)="filterControlType($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            placeholder="Select Control Type"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Frequency<sup>*</sup></label>
                        <p-autoComplete
                            [disabled]="form.get('organization').value == null"
                            appendTo="body"
                            formControlName="frequencydesc"
                            [suggestions]="filteredKeyFrequency"
                            (completeMethod)="filterKeyFrequency($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            placeholder="Select Frequency"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Automation<sup>*</sup></label>
                        <p-autoComplete
                            appendTo="body"
                            formControlName="autodesc"
                            [suggestions]="filteredKeyType"
                            (completeMethod)="filterKeyType($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            placeholder="Select Automation"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Category<sup>*</sup></label>
                        <p-autoComplete
                            [disabled]="form.get('organization').value == null"
                            appendTo="body"
                            formControlName="categorydesc"
                            [suggestions]="filteredKeyCategory"
                            (completeMethod)="filterKeyCategory($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            [multiple]="true"
                            placeholder="Select Category"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Assertion<sup>*</sup></label>
                        <p-autoComplete
                            [disabled]="form.get('organization').value == null"
                            appendTo="body"
                            formControlName="assdesc"
                            [suggestions]="filteredKeyAssertion"
                            (completeMethod)="filterKeyAssertion($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            [multiple]="true"
                            placeholder="Select Assertion"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>

                    <div class="field col-12 md:col-4">
                        <label>Key Control<sup>*</sup></label>
                        <p-autoComplete
                            [disabled]="form.get('organization').value == null"
                            appendTo="body"
                            formControlName="keydesc"
                            [suggestions]="filteredKeyControlType"
                            (completeMethod)="filterKeyControlType($event)"
                            field="text_code_value"
                            [dropdown]="true"
                            placeholder="Select Key Control"
                            [style]="{ width: '100%' }"
                        ></p-autoComplete>
                    </div>
                </div>

                <div class="col-12 flex justify-content-between mt-4">
                    <div class="ml-auto">
                        <p-button
                            type="reset"
                            label="Back"
                            icon="pi pi-arrow-left"
                            styleClass="p-button-secondary"
                            (click)="showTable = true"
                        ></p-button>
                        &nbsp;
                        <button
                            type="submit"
                            pButton
                            pRipple
                            #submitButton
                            label="Save"
                            icon="pi pi-check"
                            styleClass="p-button-primary"
                        ></button>
                    </div>
                </div>
            </form>
        </div>

        <button
            pButton
            pRipple
            title="Add"
            type="button"
            *ngIf="showTable"
            icon="pi pi-plus"
            class="p-button-rounded p-button-lg fixed add-details"
            (click)="openNew()"
        ></button>
    </div>
</div>

<!-- <p-dialog
    #textDialog
    [header]="popupHeader"
    [(visible)]="showPopupText"
    [modal]="true"
>
    <ng-template pTemplate="content">
        <form [formGroup]="textDialogForm">
            <textarea
                autofocus
                name=""
                id=""
                cols="100"
                rows="40"
                formControlName="input"
            ></textarea>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <button
            pButton
            pRipple
            label="Ok"
            icon="pi pi-check"
            class="p-button-text"
            (click)="showPopupText = false"
        ></button>
    </ng-template>
</p-dialog> -->

<!-- <p-dialog [(visible)]="showPop" [header]="showPopTitle" [modal]="true">
    <ng-template pTemplate="content">
        <textarea [value]="showContent" cols="90" rows="40" disabled></textarea>
    </ng-template>
</p-dialog> -->
