<p-toast></p-toast>
<div id="table1">
    <div class="card px-6 py-6">
        <p-toolbar styleClass="mb-4 gap-2" [style]="{ width: '100%' }">
            <ng-template pTemplate="left">
                <form
                    *ngIf="result?.length > 0"
                    [formGroup]="filterForm"
                    class="grid"
                >
                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">Organisation</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="organisations"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="Select Organisation"
                            formControlName="org"
                            [style]="{ width: '100%' }"
                        ></p-dropdown>
                    </div>

                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">Department</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="departments"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="Select Department"
                            formControlName="department"
                            [style]="{ width: '100%' }"
                        ></p-dropdown>
                    </div>

                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">From</label>
                        <p-calendar
                            [minDate]="minDate"
                            [readonlyInput]="true"
                            placeholder="From Date..."
                            formControlName="from"
                            [style]="{ width: '100%' }"
                        ></p-calendar>
                    </div>

                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">To</label>
                        <p-calendar
                            [disabled]="filterForm.get('from').value == null"
                            [minDate]="filterForm.get('from').value"
                            [readonlyInput]="true"
                            placeholder="To Date..."
                            formControlName="to"
                            [style]="{ width: '100%' }"
                        ></p-calendar>
                    </div>

                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">Review Year</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="reviewYears"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="Select Year"
                            formControlName="review_year"
                            [style]="{ width: '100%' }"
                        ></p-dropdown>
                    </div>

                    <div class="col-12 md:col-2">
                        <label class="text-l font-bold">Result</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="results"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="Select Result"
                            formControlName="result"
                            [style]="{ width: '100%' }"
                        ></p-dropdown>
                    </div>

                    <!-- <div class="col-12 md:col-2">
                        <p-button
                            icon="pi pi-filter"
                            class="ml-10"
                            iconPos="left"
                            label="Clear"
                            tooltipPosition="top"
                            styleClass="p-button-secondary"
                            (click)="filterForm.reset()"
                        ></p-button>
                    </div> -->
                </form>
            </ng-template>
        </p-toolbar>

        <p-table
            #dt
            [value]="filteredResult"
            [rowHover]="true"
            [rows]="10"
            [showCurrentPageReport]="true"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="loadingTable"
            [paginator]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            responsiveLayout="scroll"
            [scrollable]="true"
            scrollHeight="calc(100vh - 378px)"
            [filterDelay]="0"
            [globalFilterFields]="[
                'audit_history_id',
                'organization',
                'department',
                'audit_test_desc',
                'au_level_4_desc',
                'audit_risk',
                'control',
                'script_defination',
                'script_presto',
                'script_sql',
                'schedule_status',
                'schedule_start_datetime',
                'schedule_run_time',
                'created_date',
                'job_run_status_text',
                'error_message',
                'audit_run_status_text'
            ]"
        >
            <ng-template pTemplate="caption">
                <div
                    class="table-header flex justify-content-between align-items-center"
                >
                    <span class="text-xl">Audit Dashboard</span>
                    <span class="p-input-icon-left">
                        <!-- <i class="pi pi-search"></i>
                        <input
                            pInputText
                            type="text"
                            (input)="
                                dt.filterGlobal($event.target.value, 'contains')
                            "
                            placeholder="Global Search"
                        /> -->

                        <p-button
                            icon="pi pi-download"
                            class="ml-10"
                            iconPos="left"
                            label="Export"
                            pTooltip="Export to csv"
                            tooltipPosition="top"
                            styleClass="p-button-secondary"
                            (click)="downloadcav()"
                        ></p-button>
                    </span>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th
                        pSortableColumn="audit_history_id"
                        style="min-width: 14rem"
                    >
                        AUDIT TEST HISTORY ID
                        <p-sortIcon field="audit_history_id"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="audit_test_desc"
                        style="min-width: 14rem"
                    >
                        AUDIT TEST DESCRIPTION
                        <p-sortIcon field="audit_test_desc"></p-sortIcon>
                    </th>

                    <th pSortableColumn="organization" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            ORGANISATION
                            <p-sortIcon field="organization"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="department" style="min-width: 14rem">
                        <div class="flex align-items-center">
                            DEPARTMENT
                            <p-sortIcon field="department"></p-sortIcon>
                        </div>
                    </th>
                    <th
                        pSortableColumn="au_level_4_desc"
                        style="min-width: 14rem"
                    >
                        AUDIT UNIVERESE LEVEL 4 DESCRIPTION
                        <p-sortIcon field="au_level_4_desc"></p-sortIcon>
                    </th>
                    <th pSortableColumn="audit_risk" style="min-width: 14rem">
                        RISK DESCRIPTION
                        <p-sortIcon field="audit_risk"></p-sortIcon>
                    </th>
                    <th pSortableColumn="control" style="min-width: 14rem">
                        CONTROL DESCRIPTION
                        <p-sortIcon field="control"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="script_defination"
                        style="min-width: 14rem"
                    >
                        SCRIPT DEFINATION
                        <p-sortIcon field="script_defination"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="script_presto"
                        style="min-width: 14rem"
                    >
                        FEDERATED SCRIPT
                        <p-sortIcon field="script_presto"></p-sortIcon>
                    </th>
                    <th pSortableColumn="script_sql" style="min-width: 14rem">
                        SQL SCRIPT
                        <p-sortIcon field="script_sql"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="schedule_status"
                        style="min-width: 14rem"
                    >
                        SCHEDULE STATUS
                        <p-sortIcon field="schedule_status"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="schedule_start_datetime"
                        style="min-width: 14rem"
                    >
                        SCHEDULE START DATE
                        <p-sortIcon
                            field="schedule_start_datetime"
                        ></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="schedule_run_time"
                        style="min-width: 14rem"
                    >
                        SCHEDULE START TIME
                        <p-sortIcon field="schedule_run_time"></p-sortIcon>
                    </th>
                    <th pSortableColumn="created_date" style="min-width: 14rem">
                        CREATED DATE
                        <p-sortIcon field="created_date"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="job_run_status_text"
                        style="min-width: 14rem"
                    >
                        JOB RUN STATUS
                        <p-sortIcon field="job_run_status_text"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="error_message"
                        style="min-width: 14rem"
                    >
                        ERROR DESCRIPTION
                        <p-sortIcon field="error_message"></p-sortIcon>
                    </th>
                    <th
                        pSortableColumn="audit_run_status_text"
                        style="min-width: 14rem"
                    >
                        AUDIT RUN STATUS
                        <p-sortIcon field="audit_run_status_text"></p-sortIcon>
                    </th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr class="p-selectable-row" (click)="getDetail(item)">
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.audit_history_id }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.audit_test_desc.substring(0, 30) }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.organization || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.department || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.au_level_4_desc }}
                    </td>
                    <td
                        class="text-base"
                        style="min-width: 14rem"
                        (click)="
                            utilService.getFullView('Control', item.audit_risk)
                        "
                        pTooltip="click to view more"
                        tooltipPosition="bottom"
                    >
                        {{ item.audit_risk.substring(0, 30) }}
                    </td>
                    <td
                        class="text-base"
                        style="min-width: 14rem"
                        (click)="
                            utilService.getFullView('Control', item.control)
                        "
                        pTooltip="click to view more"
                        tooltipPosition="bottom"
                    >
                        {{ item.control.substring(0, 30) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 14rem">
                        {{ item.script_defination }}
                    </td>
                    <td
                        class="text-base"
                        style="min-width: 14rem"
                        (click)="
                            utilService.getFullView(
                                'Script',
                                item.script_presto
                            )
                        "
                        pTooltip="click to view more"
                        tooltipPosition="bottom"
                    >
                        {{ item.script_presto.substring(0, 30) || 'N/A' }}
                    </td>
                    <td
                        class="text-base"
                        style="min-width: 14rem"
                        (click)="
                            utilService.getFullView('Script', item.script_sql)
                        "
                        pTooltip="click to view more"
                        tooltipPosition="bottom"
                    >
                        {{ item.script_sql.substring(0, 30) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ item.schedule_status }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ (item.schedule_start_datetime | date) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ getTwoDigit(item.schedule_run_time) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ (item.created_date | date : 'medium') || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ (item.job_run_status_text | titlecase) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ (item.error_message | titlecase) || 'N/A' }}
                    </td>
                    <td class="text-base" style="min-width: 12rem">
                        {{ (item.audit_run_status_text | titlecase) || 'N/A' }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- <div class="col-12 md:col-2">
                        <label class="text-l font-bold">Audit UID</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="auditUIDs"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="audit.."
                            formControlName="selectedAuditUID"
                            [style]="{ width: '100%' }"
                        ></p-dropdown>
                    </div> -->

<!-- <div class="col-12 md:col-2"
                        ><label class="text-l font-bold">Review Year</label>
                        <p-dropdown
                            class="ml-2"
                            [options]="reviewYears"
                            optionLabel="name"
                            dataKey="code"
                            placeholder="year.."
                            formControlName="selectedReviewYear"
                            [style]="{ width: '100%' }"
                        ></p-dropdown
                    ></div> -->
