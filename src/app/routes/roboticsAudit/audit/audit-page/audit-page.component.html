<p-toast></p-toast>

<p-table
    #dt
    *ngIf="showTable"
    [value]="audits"
    selectionMode="single"
    [rows]="10"
    [loading]="loading"
    [rowHover]="true"
    [paginator]="true"
    [globalFilterFields]="[
        'audit_uid',
        'audit_board_id',
        'audit_name',
        'organization',
        'department',
        'au_level_2_desc',
        'review_year',
        'quarter',
        'start_date',
        'end_date',
        'acp_audit',
        'audit_schedule',
        'results_url',
        'last_run_date'
    ]"
    [rowsPerPageOptions]="[10, 20, 30]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [(selection)]="selectedAudit"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="calc(100vh - 320px)"
>
    <ng-template pTemplate="caption">
        <div
            class="table-header flex justify-content-between align-items-center"
        >
            <span class="text-xl">List of Audit</span>
            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input
                    pInputText
                    type="text"
                    (input)="dt.filterGlobal($event.target.value, 'contains')"
                    placeholder="Global Search"
                />
            </span>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pFrozenColumn style="min-width: 4rem"></th>
            <th pSortableColumn="audit_uid" style="min-width: 14rem">
                <div class="flex align-items-center">
                    AUDIT UID
                    <p-sortIcon field="audit_uid"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="audit_board_id" style="min-width: 14rem">
                <div class="flex align-items-center">
                    AUDIT BOARD ID
                    <p-sortIcon field="audit_board_id"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="audit_name" style="min-width: 14rem">
                <div class="flex align-items-center">
                    AUDIT NAME
                    <p-sortIcon field="audit_name"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="organization" style="min-width: 14rem">
                <div class="flex align-items-center">
                    ORGANISATION
                    <p-sortIcon field="organization"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="department" style="min-width: 14rem">
                <div class="flex align-items-center">
                    DEPARTMENT
                    <p-sortIcon field="department"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="au_level_2_desc" style="min-width: 14rem">
                <div class="flex align-items-center">
                    AU LEVEL 2
                    <p-sortIcon field="au_level_2_desc"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="review_year" style="min-width: 14rem">
                <div class="flex align-items-center">
                    REVIEW YEAR
                    <p-sortIcon field="review_year"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="quarter" style="min-width: 14rem">
                <div class="flex align-items-center">
                    QUARTER
                    <p-sortIcon field="quarter"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="start_date" style="min-width: 14rem">
                <div class="flex align-items-center">
                    START DATE
                    <p-sortIcon field="start_date"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="end_date" style="min-width: 14rem">
                <div class="flex align-items-center">
                    END DATE
                    <p-sortIcon field="end_date"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="acp_audit" style="min-width: 14rem">
                <div class="flex align-items-center">
                    ACP AUDIT
                    <p-sortIcon field="acp_audit"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="audit_schedule" style="min-width: 14rem">
                <div class="flex align-items-center">
                    AUDIT SCHEDULE
                    <p-sortIcon field="audit_schedule"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="results_url" style="min-width: 14rem">
                <div class="flex align-items-center">
                    RESULT URL
                    <p-sortIcon field="results_url"></p-sortIcon>
                </div>
            </th>

            <th pSortableColumn="last_run_date" style="min-width: 14rem">
                <div class="flex align-items-center">
                    LAST RUN DATE
                    <p-sortIcon field="last_run_date"></p-sortIcon>
                </div>
            </th>

            <th style="min-width: 120px" pFrozenColumn alignFrozen="right">
                <div class="flex align-items-center">ACTIONS</div>
            </th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
        <tr class="p-selectable-row">
            <td pFrozenColumn class="text-base" style="max-width: 4rem">
                <p-tableCheckbox
                    [value]="item"
                    (click)="selectRow(item)"
                ></p-tableCheckbox>
            </td>
            <td class="text-base">{{ item.audit_uid || 'N/A' }}</td>
            <td class="text-base">{{ item.audit_board_id || 'N/A' }}</td>
            <td class="text-base">{{ item.audit_name || 'N/A' }}</td>
            <td class="text-base">{{ item.organization || 'N/A' }}</td>
            <td class="text-base">{{ item.department || 'N/A' }}</td>
            <td class="text-base">{{ item.au_level_2_desc || 'N/A' }}</td>
            <td class="text-base">{{ item.review_year || 'N/A' }}</td>
            <td class="text-base">{{ item.quarter || 'N/A' }}</td>
            <td class="text-base">{{ item.start_date || 'N/A' }}</td>
            <td class="text-base">{{ item.end_date || 'N/A' }}</td>
            <td class="text-base">{{ item.acp_audit || 'N/A' }}</td>
            <td class="text-base">{{ item.audit_schedule || 'N/A' }}</td>
            <td class="text-base">{{ item.results_url || 'N/A' }}</td>
            <td class="text-base">{{ item.last_run_date || 'N/A' }}</td>
            <td
                class="text-base"
                style="max-width: 120px"
                pFrozenColumn
                class="font-bold"
                alignFrozen="right"
            >
                <span
                    ><button
                        pButton
                        pRipple
                        title="Edit"
                        type="button"
                        icon="pi pi-pencil"
                        class="p-button-rounded p-button-info"
                        (click)="openNew(item)"
                        *ngIf="showTable"
                    ></button>

                    <button
                        pButton
                        pRipple
                        title="Delete"
                        type="button"
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-info ml-2"
                        (click)="deleteAudit(item)"
                    ></button>
                </span>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="14">No Audit found.</td>
        </tr>
    </ng-template>
</p-table>

<div *ngIf="!showTable">
    <h5>Audit Detail</h5>
    <form [formGroup]="auditForm" class="grid">
        <div class="field col-12 md:col-4">
            <label for="department">Organisation <sup>*</sup></label>
            <p-autoComplete
                appendTo="body"
                formControlName="organization_id"
                [suggestions]="filteredOrg"
                (completeMethod)="filterOrg($event)"
                field="organization"
                [dropdown]="true"
                placeholder="Select Organisation"
                [style]="{ width: '100%' }"
            ></p-autoComplete>
        </div>
        <div class="field col-12 md:col-4">
            <label for="banner_id">Department <sup>*</sup></label>
            <p-autoComplete
                appendTo="body"
                [autoHighlight]="true"
                [forceSelection]="true"
                [completeOnFocus]="true"
                [minLength]="1"
                placeholder="Search"
                id="banner_id"
                [dropdown]="true"
                [suggestions]="filteredAuditBanner"
                (completeMethod)="filterBanner($event)"
                formControlName="banner_id"
                [style]="{ width: '100%' }"
            >
            </p-autoComplete>
        </div>
        <div class="field col-12 md:col-4">
            <label for="au_level2_id">Audit Universe <sup>*</sup></label>
            <p-autoComplete
                appendTo="body"
                [autoHighlight]="true"
                [forceSelection]="true"
                [completeOnFocus]="true"
                [minLength]="1"
                placeholder="Search"
                id="au_level_2_id"
                [dropdown]="true"
                [suggestions]="filteredAuditUniverse"
                (completeMethod)="filterAU($event)"
                formControlName="au_level_2_id"
                [disabled]="isAuditEdit"
                [style]="{ width: '100%' }"
            >
            </p-autoComplete>
        </div>
        <div class="field col-12 md:col-4">
            <label for="audit_name">Audit Name <sup>*</sup></label>
            <input
                id="audit_name"
                pInputText
                formControlName="audit_name"
                [style]="{ width: '100%' }"
            />
        </div>
        <div class="field col-12 md:col-4">
            <label for="audit_board_id">Audit Board ID <sup>*</sup></label
            ><br />
            <input
                id="audit_board_id"
                pInputText
                formControlName="audit_board_id"
                [style]="{ width: '100%' }"
            />
        </div>
        <div class="field col-12 md:col-4">
            <label for="quarter">Quarter <sup>*</sup></label>
            <p-dropdown
                appendTo="body"
                id="quarter"
                [options]="quarterList"
                formControlName="quarter"
                optionLabel="quarter"
                optionValue="code"
                [style]="{ width: '100%' }"
            ></p-dropdown>
        </div>
        <div class="field col-12 md:col-4">
            <label for="user_access"
                >User Access <sup class="opacity-0">*</sup></label
            >
            <p-multiSelect
                appendTo="body"
                id="user_access"
                [options]="listOfusers"
                formControlName="user_access_id"
                optionLabel="fullName"
                optionValue="userId"
                [style]="{ width: '100%' }"
            ></p-multiSelect>
        </div>
        <div class="field col-12 md:col-4">
            <label for="acp_audit"
                >ACP Audit <sup class="opacity-0">*</sup></label
            >
            <p-dropdown
                appendTo="body"
                id="acp_audit"
                [options]="acp_auditList"
                formControlName="acp_audit"
                optionLabel="acp_audit"
                optionValue="code"
                [style]="{ width: '100%' }"
            ></p-dropdown>
        </div>
        <div class="field col-12 md:col-4">
            <label for="results_url"
                >Result URL <sup class="opacity-0">*</sup></label
            >
            <input
                id="results_url"
                pInputText
                formControlName="results_url"
                [style]="{ width: '100%' }"
            />
        </div>
        <div class="field col-12 md:col-4">
            <label for="start_date">Start Date </label>
            <p-calendar
                appendTo="body"
                id="start_date"
                formControlName="start_date"
                showTime="true"
                [style]="{ width: '100%' }"
            ></p-calendar>
        </div>
        <div class="field col-12 md:col-4">
            <label for="end_date">End Date </label>
            <p-calendar
                [disabled]="auditForm.get('start_date').value == null"
                [minDate]="auditForm.get('start_date').value"
                appendTo="body"
                id="end_date"
                formControlName="end_date"
                showTime="true"
                [style]="{ width: '100%' }"
            ></p-calendar>
        </div>
        <div class="field col-12 md:col-4">
            <label for="audit_schedule">Audit SCHEDULE</label>
            <input
                id="audit_schedule"
                pInputText
                formControlName="audit_schedule"
                [style]="{ width: '100%' }"
            />
        </div>
        <div class="field col-12 md:col-4">
            <label for="review_year">Review Year <sup>*</sup></label>
            <input
                type="number"
                id="review_year"
                pInputText
                formControlName="review_year"
                min="1111"
                max="9999"
                [style]="{ width: '100%' }"
            />
        </div>
        <div class="col-12 flex justify-content-between mt-4">
            <div class="ml-auto">
                <p-button
                    label="Back"
                    icon="pi pi-arrow-left"
                    styleClass="p-button-secondary"
                    (click)="showTable = true"
                ></p-button>
                &nbsp;
                <button
                    pButton
                    pRipple
                    label="Save"
                    icon="pi pi-check"
                    styleClass="p-button-primary"
                    [disabled]="auditForm.invalid"
                    (click)="saveAudit()"
                ></button>
            </div>
        </div>
    </form>
</div>

<button
    *ngIf="showTable"
    pButton
    pRipple
    title="Add"
    type="button"
    icon="pi pi-plus"
    class="p-button-rounded p-button-lg fixed add-details"
    (click)="openNew(null)"
></button>
