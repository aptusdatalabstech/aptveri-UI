<p-toast></p-toast>

<p-table
    *ngIf="showTable"
    #dt2
    [value]="auditTest"
    [rows]="20"
    [loading]="loading"
    [rowHover]="true"
    [paginator]="true"
    [rowsPerPageOptions]="[20, 50, 100]"
    [showCurrentPageReport]="true"
    [(selection)]="auditTSelection"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    responsiveLayout="scroll"
    [scrollable]="true"
    [globalFilterFields]="[
        'ap_name',
        'audit_test_id',
        'audit_test_desc',
        'organization',
        'department',
        'au_level_4_desc',
        'audit_risk',
        'control',
        'banner',
        'script_defination',
        'script_presto',
        'script_sql',
        'schedule_status',
        'schedule_start_datetime',
        'schedule_end_datetime',
        'last_run_date',
        'full_name'
    ]"
>
    <ng-template pTemplate="caption">
        <div
            class="table-header flex justify-content-between align-items-center"
        >
            <span class="text-xl"
                >List of Audit Test
                <span *ngIf="auditProgram"
                    >({{ auditProgram[0].ap_name }})</span
                ></span
            >
            <span class="flex justify-content-between align-items-center"
                ><span class="p-input-icon-left mr-5">
                    <i class="pi pi-search"></i>
                    <input
                        pInputText
                        type="text"
                        (input)="
                            dt.filterGlobal($event.target.value, 'contains')
                        "
                        placeholder="Global Search"
                    /> </span
            ></span>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pFrozenColumn style="min-width: 4rem"></th>

            <th pSortableColumn="audit_test_id" style="min-width: 14rem">
                <div class="flex align-items-center">
                    <p-sortIcon field="audit_test_id"></p-sortIcon>
                    AUDIT TEST ID
                </div>
            </th>

            <th pSortableColumn="audit_test_desc" style="min-width: 14rem">
                <p-sortIcon field="audit_test_desc"></p-sortIcon>
                AUDIT TEST DESCRIPTION
                <p-columnFilter
                    type="text"
                    field="audit_test_desc"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>

            <th pSortableColumn="organization" style="min-width: 14rem">
                <div class="flex align-items-center">
                    <p-sortIcon field="organization"></p-sortIcon>
                    ORGANISATION
                    <p-columnFilter
                        type="text"
                        field="organization"
                        display="menu"
                        class="ml-auto"
                    ></p-columnFilter>
                </div>
            </th>

            <th pSortableColumn="department" style="min-width: 14rem">
                <div class="flex align-items-center">
                    <p-sortIcon field="department"></p-sortIcon>
                    DEPARTMENT
                    <p-columnFilter
                        type="text"
                        field="department"
                        display="menu"
                        class="ml-auto"
                    ></p-columnFilter>
                </div>
            </th>
            <th pSortableColumn="au_level_4_desc" style="min-width: 14rem">
                <p-sortIcon field="au_level_4_desc"></p-sortIcon>
                AUDIT UNIVERESE LEVEL 4
                <p-columnFilter
                    type="text"
                    field="au_level_4_desc"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="audit_risk" style="min-width: 14rem">
                <p-sortIcon field="audit_risk"></p-sortIcon>
                RISK DESCRIPTION
                <p-columnFilter
                    type="text"
                    field="audit_risk"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="control" style="min-width: 14rem">
                <p-sortIcon field="control"></p-sortIcon>
                CONTROL DESCRIPTION
                <p-columnFilter
                    type="text"
                    field="control"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="banner" style="min-width: 14rem">
                <p-sortIcon field="banner"></p-sortIcon>
                DEPARTMENT DESCRIPTION
                <p-columnFilter
                    type="text"
                    field="banner"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="script_defination" style="min-width: 14rem">
                <p-sortIcon field="script_defination"></p-sortIcon>
                SCRIPT DEFINATION
                <p-columnFilter
                    type="text"
                    field="script_defination"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="script_presto" style="min-width: 14rem">
                <p-sortIcon field="script_presto"></p-sortIcon>
                FEDERATED SCRIPT
                <p-columnFilter
                    type="text"
                    field="script_presto"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="script_sql" style="min-width: 14rem">
                <p-sortIcon field="script_sql"></p-sortIcon>
                SQL SCRIPT
                <p-columnFilter
                    type="text"
                    field="script_sql"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="schedule_status" style="min-width: 14rem">
                <p-sortIcon field="schedule_status"></p-sortIcon>
                SCHEDULE STATUS
                <p-columnFilter
                    type="text"
                    field="schedule_status"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th
                pSortableColumn="schedule_start_datetime"
                style="min-width: 14rem"
            >
                <p-sortIcon field="schedule_start_datetime"></p-sortIcon>
                SCHEDULE START DATE
                <p-columnFilter
                    type="date"
                    field="schedule_start_datetime"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th
                pSortableColumn="schedule_end_datetime"
                style="min-width: 14rem"
            >
                <p-sortIcon field="schedule_end_datetime"></p-sortIcon>
                SCHEDULE END DATE
                <p-columnFilter
                    type="date"
                    field="schedule_end_datetime"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="last_run_date" style="min-width: 14rem">
                <p-sortIcon field="last_run_date"></p-sortIcon>
                LAST RUN DATE
                <p-columnFilter
                    type="date"
                    field="last_run_date"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>
            <th pSortableColumn="full_name" style="min-width: 14rem">
                <p-sortIcon field="full_name"></p-sortIcon>
                CREATED BY
                <p-columnFilter
                    type="text"
                    field="full_name"
                    display="menu"
                    class="ml-auto"
                ></p-columnFilter>
            </th>

            <th style="min-width: 100px" pFrozenColumn alignFrozen="right">
                <div class="flex align-items-center">ACTIONS</div>
            </th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
        <tr class="p-selectable-row">
            <td pFrozenColumn class="text-base" style="max-width: 4rem">
                <p-tableCheckbox
                    [value]="item"
                    (click)="selectTest(item)"
                ></p-tableCheckbox>
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.audit_test_id || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.audit_test_desc.substring(0, 30) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.organization || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.department || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.au_level_4_desc || 'N/A' }}
            </td>
            <td
                class="text-base"
                style="min-width: 14rem"
                (click)="utilService.getFullView('Process', item.audit_risk)"
                pTooltip="click to view more"
                tooltipPosition="bottom"
            >
                {{ item.audit_risk.substring(0, 30) || 'N/A' }}
            </td>
            <td
                class="text-base"
                style="min-width: 14rem"
                (click)="utilService.getFullView('Control', item.control)"
                pTooltip="click to view more"
                tooltipPosition="bottom"
            >
                {{ item.control.substring(0, 30) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.banner || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.script_defination || 'N/A' }}
            </td>
            <td
                class="text-base"
                style="min-width: 14rem"
                (click)="utilService.getFullView('Script', item.script_presto)"
                pTooltip="click to view more"
                tooltipPosition="bottom"
            >
                {{ item.script_presto.substring(0, 20) || 'N/A' }}
            </td>
            <td
                class="text-base"
                style="min-width: 14rem"
                (click)="utilService.getFullView('Script', item.script_sql)"
                pTooltip="click to view more"
                tooltipPosition="bottom"
            >
                {{ item.script_sql.substring(0, 20) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.schedule_status || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ (item.schedule_start_datetime | date) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ (item.schedule_end_datetime | date) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ (item.last_run_date | date) || 'N/A' }}
            </td>
            <td class="text-base" style="min-width: 14rem">
                {{ item.full_name || 'N/A' }}
            </td>
            <td
                class="text-base"
                style="min-width: 100px"
                pFrozenColumn
                class="font-bold"
                alignFrozen="right"
            >
                <span
                    ><button
                        pButton
                        pRipple
                        title="Edit"
                        type="button"
                        icon="pi pi-pencil"
                        class="p-button-rounded p-button-info"
                        (click)="openT(item)"
                        *ngIf="showTable"
                    ></button>

                    <button
                        pButton
                        pRipple
                        title="Delete"
                        type="button"
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-info ml-2"
                        (click)="deleteTest(item)"
                    ></button>
                </span>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="18">No Audit Tests found.</td>
        </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
        <tr>
            <td colspan="18">Loading Audit Tests data. Please wait.</td>
        </tr>
    </ng-template>
</p-table>

<p-speedDial
    *ngIf="showTable"
    className="add-details"
    [model]="items"
    direction="up"
></p-speedDial>

<div *ngIf="!showTable">
    <form
        [formGroup]="auditTestForm"
        (ngSubmit)="auditTestForm.valid && auditTestFormSubmit()"
    >
        <div class="grid">
            <div
                *ngIf="auditProgram"
                class="field col-12 md:col-6 mb-2 p-dialog-content"
            >
                <div class="field">
                    <label for="audit">Audit Program <sup>*</sup></label>
                    <input
                        id="audit"
                        pInputText
                        [style]="{ width: '100%' }"
                        [value]="auditProgram[0].ap_name"
                        disabled
                    />
                </div>
            </div>
            <div class="field col-12 md:col-6">
                <label for="audit_test_desc"
                    >Audit Test Description <sup>*</sup></label
                >
                <input
                    id="audit_test_desc"
                    pInputText
                    formControlName="audit_test_desc"
                    [style]="{ width: '100%' }"
                />
            </div>
        </div>

        <div class="grid">
            <div class="col align-self-center">
                <div class="field">
                    <label for="au_id">Organization<sup>*</sup></label>
                    <p-autoComplete
                        appendTo="body"
                        formControlName="organization_id"
                        [suggestions]="filteredOrg"
                        (completeMethod)="filterOrg($event)"
                        [dropdown]="true"
                        placeholder="Select Organisation"
                        [style]="{ width: '100%' }"
                        [disabled]="auditTestMode == 'edit'"
                    ></p-autoComplete>
                </div>
            </div>
            <div class="field col-12 md:col-6">
                <label for="au_id">Department<sup>*</sup></label>
                <p-autoComplete
                    appendTo="body"
                    placeholder="Search"
                    [dropdown]="true"
                    [multiple]="false"
                    [suggestions]="filteredDepartment"
                    (completeMethod)="filterDepartment($event)"
                    formControlName="department_id"
                    [style]="{ width: '100%' }"
                ></p-autoComplete>
                <span *ngIf="filteredDepartment?.length == 0"
                    ><small class="p-error">No Records Found</small></span
                >
            </div>

            <div class="field col-12 md:col-6">
                <label for="au_id">Audit Universe L4 <sup>*</sup></label>
                <p-autoComplete
                    appendTo="body"
                    placeholder="Search"
                    [dropdown]="true"
                    [suggestions]="filteredAuditUniverse4"
                    (completeMethod)="filterAuditUniverse4($event)"
                    formControlName="au_level_4_id"
                    (onSelect)="onAuditUniverse4Select($event)"
                    [style]="{ width: '100%' }"
                ></p-autoComplete>
                <small *ngIf="auditUniverse4?.length == 0" class="p-error"
                    >No scripts found with related Audit program AU Level
                    3</small
                >
            </div>

            <div class="field col-12 md:col-6">
                <label for="">Control <sup>*</sup></label>
                <p-progressSpinner
                    *ngIf="loadingControl"
                    [style]="{
                        width: '40px',
                        height: '40px'
                    }"
                    styleClass="custom-spinner"
                    strokeWidth="8"
                    animationDuration=".5s"
                ></p-progressSpinner>
                <p-autoComplete
                    *ngIf="!loadingControl"
                    placeholder="Search"
                    [showTransitionOptions]="'0ms'"
                    [hideTransitionOptions]="'0ms'"
                    [dropdown]="true"
                    [multiple]="false"
                    [suggestions]="filteredControl"
                    (completeMethod)="filterControl($event)"
                    formControlName="control_id"
                    [disabled]="isControlEnable"
                    (onSelect)="onControlSelect($event); isScriptEnable = false"
                    [style]="{ width: '100%' }"
                ></p-autoComplete>
                <span *ngIf="!isControlEnable">
                    <small *ngIf="controld?.length == 0" class="p-error"
                        >No Control Found</small
                    >
                </span>
            </div>
            <div class="field col-12 md:col-6">
                <label for="au_id">Risk <sup>*</sup></label>
                <p-progressSpinner
                    *ngIf="loadingRisk"
                    [style]="{
                        width: '40px',
                        height: '40px'
                    }"
                    styleClass="custom-spinner"
                    strokeWidth="8"
                    animationDuration=".5s"
                ></p-progressSpinner>
                <p-autoComplete
                    *ngIf="!loadingRisk"
                    [disabled]="isRiskEnable"
                    placeholder="Search"
                    [dropdown]="true"
                    [suggestions]="filteredRisk"
                    (completeMethod)="filterRisk($event)"
                    formControlName="risk_id"
                    (onSelect)="onRiskSelect($event); isControlEnable = false"
                    [style]="{ width: '100%' }"
                ></p-autoComplete>
                <span *ngIf="!isRiskEnable">
                    <small *ngIf="riskd?.length == 0" class="p-error"
                        >No Risk Found</small
                    >
                </span>
            </div>

            <div class="field col-12 md:col-6">
                <label for="">Script <sup>*</sup></label>
                <p-progressSpinner
                    *ngIf="loadingScript"
                    [style]="{
                        width: '40px',
                        height: '40px'
                    }"
                    styleClass="custom-spinner"
                    strokeWidth="8"
                    animationDuration=".5s"
                ></p-progressSpinner>
                <p-autoComplete
                    *ngIf="!loadingScript"
                    appendTo="body"
                    placeholder="Search"
                    [showTransitionOptions]="'0ms'"
                    [hideTransitionOptions]="'0ms'"
                    [dropdown]="true"
                    [multiple]="false"
                    [suggestions]="filteredScript"
                    (completeMethod)="filterScript($event)"
                    formControlName="script_id"
                    (onSelect)="onSelectScript($event)"
                    [disabled]="isScriptEnable"
                    [style]="{ width: '100%' }"
                ></p-autoComplete>
            </div>
            <div *ngIf="noScript" class="text-center text-xl">
                <span class="text-pink-500"
                    >There are no active scripts for this combination</span
                >
            </div>

            <div
                style="display: table"
                class="selectedVal"
                *ngIf="scriptSelection && script?.length > 0"
            >
                <div *ngIf="scriptSelection">
                    <div
                        formArrayName="scriptVariables"
                        *ngFor="
                            let item of auditTestForm.get('scriptVariables')
                                .controls;
                            let i = index
                        "
                    >
                        <div
                            class="grid align-items-baseline"
                            *ngIf="
                                !scriptDefaultVariables.includes(
                                    scriptSelection.scriptVaribales[i].var_name
                                )
                            "
                        >
                            <div class="col font-bold">
                                {{
                                    scriptSelection.scriptVaribales[i].var_name
                                }}
                            </div>
                            <div class="col font-bold">
                                {{
                                    scriptSelection.scriptVaribales[i]
                                        .var_datatype
                                }}
                            </div>
                            <div class="col" [formGroupName]="i">
                                <div class="field">
                                    <input
                                        pInputText
                                        formControlName="var_value"
                                        placeholder="Variable Value"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <table class="selectedVal">
                <tr>
                    <td class="text-base" style="width: 20% !important">
                        Audit Universe L4
                    </td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.auditTestForm.get('au_level_4_id').value,
                                'Audit Universe L4'
                            )
                        "
                    >
                        {{ this.auditTestForm.get('au_level_4_id').value }}
                    </td>
                </tr>
                <tr>
                    <td>Risk Description</td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.auditTestForm.get('risk_id').value,
                                'Risk'
                            )
                        "
                    >
                        {{ this.auditTestForm.get('risk_id').value }}
                    </td>
                </tr>
                <tr>
                    <td>Control Description</td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.auditTestForm.get('control_id').value,
                                'Control'
                            )
                        "
                    >
                        {{ this.auditTestForm.get('control_id').value }}
                    </td>
                </tr>
                <tr>
                    <td>Script Description</td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.auditTestForm.get('script_id').value,
                                'Script'
                            )
                        "
                    >
                        {{ this.auditTestForm.get('script_id').value }}
                    </td>
                </tr>
                <tr>
                    <td>Presto Script</td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.scriptSelection.script_presto,
                                'Presto Script'
                            )
                        "
                    >
                        <div *ngIf="scriptSelection">
                            {{ this.scriptSelection.script_presto }}
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>SQL Script</td>
                    <td
                        title="Click to view full detail"
                        style="
                            width: 70% !important;

                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                        (click)="
                            showScript(
                                this.scriptSelection.script_sql,
                                'SQL Script'
                            )
                        "
                    >
                        <div *ngIf="scriptSelection">
                            {{ this.scriptSelection.script_sql }}
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="col-12 flex justify-content-between mt-4">
            <div class="ml-auto">
                <p-button
                    type="reset"
                    label="Back"
                    icon="pi pi-arrow-left"
                    styleClass="p-button-secondary"
                    (click)="showTable = true"
                ></p-button>
                &nbsp;
                <button
                    [disabled]="!auditTestForm.valid"
                    type="submit"
                    pButton
                    pRipple
                    #submitButton
                    label="Save"
                    icon="pi pi-check"
                    styleClass="p-button-primary"
                ></button>
            </div>
        </div>
    </form>
</div>
